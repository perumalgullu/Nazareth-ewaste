<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Data Engineer Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Poppins', sans-serif; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">

  <div class="max-w-5xl mx-auto space-y-6">

    <div class="flex justify-between items-center bg-white p-4 rounded shadow border border-gray-200">
      <h2 class="text-xl md:text-2xl font-semibold text-gray-800">üëã Welcome Officer</h2>
      <div class="flex gap-2">
        <a href="index.html" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition">Logout</a>
        <button id="printBtn" onclick="printCertificate()" 
          class="bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded transition hidden">
          Print Certificate
        </button>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow border border-gray-200">
      <label for="userPhone" class="block text-gray-700 font-semibold mb-1">üìû User Phone Number</label>
      <input type="tel" id="userPhone" placeholder="Enter 10-digit phone number"
        pattern="[6-9]{1}[0-9]{9}" maxlength="10"
        class="w-full border border-gray-300 p-3 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
        required>
    </div>

    <form id="productForm" class="bg-white p-6 rounded shadow border border-gray-200 space-y-4" onsubmit="return false;">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <select id="productCategory" onchange="populateProductNames()" class="border border-gray-300 p-3 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">üìÇ Select Category</option>
          <option>Large Appliances</option>
          <option>Small Appliances</option>
          <option>IT & Telecom</option>
          <option>Consumer Electronics</option>
          <option>Lighting Equipment</option>
          <option>Electrical Tools</option>
          <option>Toys & Sports</option>
          <option>Medical Devices</option>
          <option>Monitoring Devices</option>
          <option>Batteries & Cables</option>
        </select>

        <input list="productList" id="productName" placeholder="üì¶ Select or type product"
          class="border border-gray-300 p-3 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        <datalist id="productList"></datalist>

        <select id="reuseCategory" class="border border-gray-300 p-3 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">‚ôªÔ∏è Select Condition</option>
          <option>Reuse</option>
          <option>Refurbishable</option>
          <option>Disposal</option>
        </select>

        <input type="number" step="0.01" id="weight" placeholder="‚öñÔ∏è Weight (kg)"
          class="border border-gray-300 p-3 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <div class="flex justify-end gap-2 mt-2">
        <button type="button" onclick="addProductToTable()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">‚ûï Add Product</button>
        <button type="button" onclick="resetFormAndScroll()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition">üîÑ New Submission</button>
      </div>
    </form>

    <div id="submittedTable" class="hidden bg-white p-4 rounded shadow border border-gray-200 overflow-x-auto">
      <table class="w-full text-sm text-center">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="py-2">#</th>
            <th>User_id</th>
            <th>Category</th>
            <th>Product</th>
            <th>Condition</th>
            <th>Weight</th>
            <th>CO‚ÇÇ</th>
            <th>Cashback</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot class="bg-gray-50 font-semibold">
          <tr>
            <td colspan="5" class="text-right py-2">Total</td>
            <td id="totalWeight">0.00</td>
            <td id="totalCO2">0.00</td>
            <td id="totalCashback">0</td>
            <td>-</td>
          </tr>
          <tr>
            <td colspan="9" class="text-right pt-4">
              <button type="button" onclick="handleSubmitAll()" class="bg-purple-700 hover:bg-purple-800 text-white px-6 py-2 rounded transition">‚úÖ Submit All</button>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // ‚úÖ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyC_Q7n0l6MEI3ySJCLra6xl5oSc9_Pwuzc",
      authDomain: "ewaste-bafdd.firebaseapp.com",
      databaseURL: "https://ewaste-bafdd-default-rtdb.firebaseio.com",
      projectId: "ewaste-bafdd",
      storageBucket: "ewaste-bafdd.firebasestorage.app",
      messagingSenderId: "725818718552",
      appId: "1:725818718552:web:cdc26b05044ba3a5ad4d2d",
      measurementId: "G-LG05FY3PRD"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const categoryOptions = {
      "Large Appliances": ["Refrigerator", "Washing Machine", "Air Conditioner"],
      "Small Appliances": ["Mixer", "Toaster", "Electric Kettle"],
      "IT & Telecom": ["Laptop", "Desktop CPU", "Mobile Phone", "Tablet"],
      "Consumer Electronics": ["TV", "CRT Monitor", "Set-top Box"],
      "Lighting Equipment": ["LED Bulb", "Tube Light"],
      "Electrical Tools": ["Drill", "Soldering Iron"],
      "Toys & Sports": ["Remote Car", "Electronic Toy"],
      "Medical Devices": ["Glucometer", "Digital Thermometer"],
      "Monitoring Devices": ["CCTV Camera", "Door Alarm"],
      "Batteries & Cables": ["Power Bank", "USB Cable"]
    };

    function populateProductNames() {
      const category = document.getElementById("productCategory").value;
      const products = categoryOptions[category] || [];
      const productList = document.getElementById("productList");
      productList.innerHTML = products.map(p => `<option value="${p}">`).join('');
    }

    let submittedProducts = [];

    function resetFormAndScroll() {
      document.getElementById("productForm").reset();
      submittedProducts = [];
      updateTable();
      document.getElementById("submittedTable").classList.add("hidden");
      const phoneInput = document.getElementById("userPhone");
      phoneInput.value = "";
      phoneInput.disabled = false;
      document.getElementById("printBtn").classList.add("hidden");
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateTable() {
      const tableBody = document.getElementById("tableBody");
      tableBody.innerHTML = "";
      let totalWeight = 0, totalCO2 = 0, totalCashback = 0;

      submittedProducts.forEach((p, i) => {
        tableBody.innerHTML += `
          <tr class="border-t">
            <td class="py-2">${i + 1}</td>
            <td>${p.userId}</td>
            <td>${p.category}</td>
            <td>${p.product}</td>
            <td>${p.condition}</td>
            <td>${p.weight}</td>
            <td>${p.co2.toFixed(2)}</td>
            <td>‚Çπ${p.cashback.toFixed(0)}</td>
            <td class="px-2 text-center">
              <button onclick="editProduct(${i})" class="text-yellow-600">‚úèÔ∏è</button>
              <button onclick="deleteProduct(${i})" class="text-red-600 ml-2">üóë</button>
            </td>
          </tr>`;
        totalWeight += parseFloat(p.weight);
        totalCO2 += p.co2;
        totalCashback += p.cashback;
      });

      document.getElementById("totalWeight").textContent = totalWeight.toFixed(2);
      document.getElementById("totalCO2").textContent = totalCO2.toFixed(2);
      document.getElementById("totalCashback").textContent = totalCashback.toFixed(0);

      if (submittedProducts.length > 0) {
        document.getElementById("submittedTable").classList.remove("hidden");
      }
    }

    function deleteProduct(index) {
      if (confirm("Are you sure?")) {
        submittedProducts.splice(index, 1);
        updateTable();
      }
    }

    function editProduct(index) {
      const item = submittedProducts[index];
      document.getElementById("productCategory").value = item.category;
      populateProductNames();
      document.getElementById("productName").value = item.product;
      document.getElementById("reuseCategory").value = item.condition;
      document.getElementById("weight").value = item.weight;
      submittedProducts.splice(index, 1);
      updateTable();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function addProductToTable() {
      const userId = document.getElementById("userPhone").value.trim();
      const category = document.getElementById("productCategory").value;
      const product = document.getElementById("productName").value;
      const condition = document.getElementById("reuseCategory").value;
      const weight = parseFloat(document.getElementById("weight").value);

      const phonePattern = /^[6-9]\d{9}$/;
      if (!phonePattern.test(userId)) {
        alert("Please enter a valid 10-digit phone number.");
        return;
      }

      if (!category || !product || !condition || isNaN(weight)) {
        alert("Please fill all fields.");
        return;
      }

      const multipliers = { "Reuse": 2.5, "Refurbishable": 1.8, "Disposal": 1.2 };
      const co2 = weight * multipliers[condition];
      const cashback = co2 * 2;

      submittedProducts.push({ userId, category, product, condition, weight, co2, cashback });
      updateTable();
      document.getElementById("productForm").reset();
      document.getElementById("userPhone").disabled = true;
    }

    function handleSubmitAll() {
        if (submittedProducts.length === 0) {
            alert("No products to submit!");
            return;
        }

        // ‚úÖ UPDATED CODE: Create a timestamp with both date and time
        const timestamp = new Date().toLocaleString("en-GB", {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true // Use false for 24-hour format
        });

        submittedProducts.forEach(item => {
            firebase.database().ref("ewasteSubmissions").push().set({
                ...item,
                createdAt: timestamp // Use the new timestamp
            });
        });

        alert("‚úÖ All products are saved successfully!");
        document.getElementById("printBtn").classList.remove("hidden");

        // generate certificate BEFORE clearing data
        printCertificate();

        // now reset
        document.getElementById("productForm").reset();
        submittedProducts = [];
        updateTable();
        document.getElementById("submittedTable").classList.add("hidden");
        document.getElementById("userPhone").disabled = false;
    }


    function printCertificate() {
      const username = document.getElementById("userPhone").value || "User";
      const date = new Date().toLocaleDateString("en-GB");

      const totalWeight = document.getElementById("totalWeight").textContent || "0";
      const totalCO2 = document.getElementById("totalCO2").textContent || "0";
      const totalCashback = document.getElementById("totalCashback").textContent || "0";

      const content = `
        <html>
          <head>
            <title>Certificate</title>
            <style>
              @media print {
                @page {
                  margin: 0;
                  size: A4 portrait;
                }
                body { margin: 0; }
              }
              body { 
                font-family: 'Poppins', sans-serif; 
                background: #fdfcf7; 
                display: flex; 
                justify-content: center; 
                align-items: center; 
                height: 100vh; 
              }
              .cert-container { 
                border: 12px solid #c9a94d; 
                padding: 60px; 
                border-radius: 15px; 
                background: #fffef9; 
                width: 80%; 
                max-width: 800px; 
                text-align: center;
                box-shadow: 0 0 15px rgba(0,0,0,0.15);
              }
              .logo { width: 100px; margin-bottom: 10px; }
              .college { 
                font-size: 32px; 
                font-weight: 900; 
                color: #c9a94d; 
                text-transform: uppercase; 
                margin-bottom: 8px; 
              }
              .location { font-size: 16px; color: #555; margin-bottom: 20px; }
              .cert-title { font-size: 42px; font-weight: 700; color: #2c3e50; margin-bottom: 10px; }
              .cert-subtitle { font-size: 20px; color: #555; margin-bottom: 40px; }
              .cert-name { font-size: 34px; font-weight: 600; color: #1f2937; margin: 20px 0; border-bottom: 2px solid #c9a94d; display: inline-block; padding: 5px 20px; }
              .cert-body { font-size: 18px; color: #444; margin: 25px 0; }
              .cert-stats { font-size: 18px; color: #222; margin-top: 30px; text-align: left; display: inline-block; padding: 20px; border: 2px solid #c9a94d; border-radius: 10px; background: #fff; }
              .cert-stats p { margin: 8px 0; }
              .cert-date { margin-top: 30px; font-size: 16px; color: #555; }
              .seal { margin-top: 40px; width: 120px; height: 120px; border-radius: 50%; border: 5px solid #c9a94d; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: #c9a94d; background: #fffef9; margin-left: auto; margin-right: auto; }
            </style>
          </head>
          <body>
              <div class="cert-container">
              <img src="logo.png" alt="Nazareth College Crest" class="logo">
              <div class="college">Nazareth College of Arts and Science</div>
              <div class="location">Avadi, Chennai - 600062</div>

              <div class="cert-title">Certificate of Contribution</div>
              <div class="cert-subtitle">This is proudly presented to</div>
              <div class="cert-name">${username}</div>
              <div class="cert-body">
                In recognition of your valuable contribution towards<br>
                responsible e-waste management and sustainability.
              </div>

              <div class="cert-stats">
                <p><strong>Total Weight Collected:</strong> ${totalWeight} kg</p>
                <p><strong>Total CO‚ÇÇ Saved:</strong> ${totalCO2} kg</p>
                <p><strong>Total Cashback Earned:</strong> ‚Çπ${totalCashback}</p>
              </div>

              <div class="cert-date">Date: ${date}</div>
              <div class="seal">AUTHORIZED</div>
            </div>
          </body>
        </html>
      `;

      const win = window.open('', '', 'width=900,height=650');
      win.document.write(content);
      win.document.close();
      win.print();
    }
  </script>
</body>
</html>