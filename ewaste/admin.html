<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard (Firebase)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC_Q7n0l6MEI3ySJCLra6xl5oSc9_Pwuzc",
            authDomain: "ewaste-bafdd.firebaseapp.com",
            databaseURL: "https://ewaste-bafdd-default-rtdb.firebaseio.com",
            projectId: "ewaste-bafdd",
            storageBucket: "ewaste-bafdd.firebasestorage.app",
            messagingSenderId: "725818718552",
            appId: "1:725818718552:web:cdc26b05044ba3a5ad4d2d",
            measurementId: "G-LG05FY3PRD"
        };
        firebase.initializeApp(firebaseConfig);
        const realtimeDB = firebase.database();
    </script>
    <style>
        .summary-btn { background-color: #f3e8ff; color: #8b5cf6; border: 1px solid #c4b5fd; padding: 8px 16px; border-radius: 9999px; font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
        .summary-btn:hover { background-color: #e9d5ff; color: #7c3aed; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-100 to-blue-100 min-h-screen p-4" id="vanta-bg">
    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-700">Admin Dashboard</h1>
            <div>
                <a href="index.html" class="bg-gray-200 text-black px-4 py-2 rounded hover:bg-gray-300 mr-2">üè† Home</a>
                <a href="admin-login.html" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</a>
            </div>
        </div>

        <form id="filterForm" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
            <div><label class="block mb-1 text-sm">Start Date</label><input type="date" id="startDate" class="p-2 border rounded w-full" /></div>
            <div><label class="block mb-1 text-sm">End Date</label><input type="date" id="endDate" class="p-2 border rounded w-full" /></div>
            <div><label class="block mb-1 text-sm">Category</label><select id="categoryFilter" class="p-2 border rounded w-full"><option value="">All</option></select></div>
            <div><label class="block mb-1 text-sm">Product</label><select id="productFilter" class="p-2 border rounded w-full"><option value="">All</option></select></div>
            <div><label class="block mb-1 text-sm">Condition</label><select id="conditionFilter" class="p-2 border rounded w-full"><option value="">All</option></select></div>
            <div class="md:col-span-3 lg:col-span-5 text-center mt-2"><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Apply Filters</button></div>
        </form>

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white shadow border rounded">
                <thead class="bg-blue-500 text-white text-sm uppercase">
                    <tr>
                        <th class="py-3 px-4 text-center">S.No</th>
                        <th class="py-3 px-4 text-left">User Phone</th>
                        <th class="py-3 px-4 text-left">Category</th>
                        <th class="py-3 px-4 text-left">Product</th>
                        <th class="py-3 px-4 text-left">Condition</th>
                        <th class="py-3 px-4 text-right">Weight (kg)</th>
                        <th class="py-3 px-4 text-right">CO‚ÇÇ Reduced</th>
                        <th class="py-3 px-4 text-right">Cashback (‚Çπ)</th>
                        <th class="py-3 px-4 text-center">Submitted</th>
                    </tr>
                </thead>
                <tbody id="dataBody" class="text-sm text-gray-700">
                    <tr><td colspan="9" class="text-center py-4 text-gray-500">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <button id="chat-icon-button" class="fixed bottom-5 right-5 w-16 h-16 bg-pink-600 rounded-full shadow-lg flex items-center justify-center text-white hover:bg-pink-700 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg>
    </button>
    <div id="chat-widget-container" class="hidden fixed bottom-24 right-5 w-full max-w-md bg-white rounded-xl shadow-2xl flex flex-col h-[70vh] z-40">
        <div class="flex flex-col flex-grow overflow-hidden">
            <div class="bg-blue-600 text-white p-4 flex items-center justify-between"><h1 class="text-xl font-bold">Data Assistant</h1><button id="close-chat-button" class="text-white hover:bg-blue-700 rounded-full p-1"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></button></div>
            <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4 bg-gray-100"><div class="flex items-start"><div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-sm">AI</div><div class="ml-3 bg-white p-3 rounded-xl max-w-[80%] shadow-sm"><p class="text-sm text-gray-800">Hello! Ask me for a summary of today's submissions!</p></div></div></div>
            <div class="p-4 bg-gray-50 border-t"><div class="flex items-center justify-center mb-2"><button id="summary-button" class="summary-btn">‚ú® Summarize Conversation ‚ú®</button></div><div class="flex items-center space-x-2"><input id="user-input" type="text" placeholder="e.g., How much CO2 was saved today?" class="flex-grow p-3 rounded-full border focus:outline-none focus:ring-2 focus:ring-blue-500"><button id="send-button" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.981.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.405Z" /></svg></button></div></div>
        </div>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    const dataBody = document.getElementById("dataBody");
    const categoryFilter = document.getElementById("categoryFilter");
    const productFilter = document.getElementById("productFilter");
    const conditionFilter = document.getElementById("conditionFilter");
    const filterForm = document.getElementById("filterForm");
    let allData = [];
    const submissionsRef = realtimeDB.ref("ewasteSubmissions");

    function parseTimestamp(timestamp) {
        if (!timestamp || typeof timestamp !== 'string') return null;
        const datePart = timestamp.split(',')[0].trim();
        const parts = datePart.split('/'); 
        if (parts.length !== 3) return null;
        
        const day = Number(parts[0]);
        const month = Number(parts[1]) - 1; 
        const year = Number(parts[2]);

        if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
        
        const date = new Date(year, month, day);
        date.setHours(0, 0, 0, 0);
        return date;
    }

    function formatDate(value) { return value || "N/A"; }

    submissionsRef.on("value", (snapshot) => {
        allData = [];
        if (snapshot.exists()) {
            snapshot.forEach((child) => { allData.push(child.val()); });
            renderTable(allData);
            populateFilters(allData);
        } else {
            dataBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-red-500">No records found.</td></tr>`;
        }
    });

    function renderTable(data) {
        if (!data || !data.length) {
            dataBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-red-500">No matching records found.</td></tr>`;
            return;
        }
        dataBody.innerHTML = "";
        data.forEach((item, index) => {
            const row = `
                <tr class="border-b hover:bg-blue-50 odd:bg-gray-50">
                    <td class="py-2 px-4 text-center">${index + 1}</td>
                    <td class="py-2 px-4">${item.userId || 'N/A'}</td>
                    <td class="py-2 px-4">${item.category || 'N/A'}</td>
                    <td class="py-2 px-4">${item.product || 'N/A'}</td>
                    <td class="py-2 px-4">${item.condition || 'N/A'}</td>
                    <td class="py-2 px-4 text-right">${(item.weight || 0).toFixed(2)}</td>
                    <td class="py-2 px-4 text-right">${(item.co2 || 0).toFixed(2)}</td>
                    <td class="py-2 px-4 text-right">${(item.cashback || 0).toFixed(0)}</td>
                    <td class="py-2 px-4 text-center">${formatDate(item.createdAt)}</td>
                </tr>`;
            dataBody.innerHTML += row;
        });
    }

    // --- UPDATED FILTER LOGIC ---
    filterForm.addEventListener("submit", (e) => {
        e.preventDefault();
        let filtered = [...allData];
        const start = document.getElementById("startDate").value;
        const end = document.getElementById("endDate").value;
        const category = categoryFilter.value;
        const product = productFilter.value;
        const condition = conditionFilter.value;

        const startDate = start ? new Date(start) : null;
        if (startDate) startDate.setHours(0, 0, 0, 0);

        const endDate = end ? new Date(end) : null;
        if (endDate) endDate.setHours(23, 59, 59, 999);

        if (startDate || endDate) {
            filtered = filtered.filter(d => {
                const rowDate = parseTimestamp(d.createdAt);
                if (!rowDate) return false;

                const isAfterStart = !startDate || rowDate.getTime() >= startDate.getTime();
                const isBeforeEnd = !endDate || rowDate.getTime() <= endDate.getTime();

                return isAfterStart && isBeforeEnd;
            });
        }

        if (category) filtered = filtered.filter(d => d.category === category);
        if (product) filtered = filtered.filter(d => d.product === product);
        if (condition) filtered = filtered.filter(d => d.condition === condition);

        renderTable(filtered);
    });
});
</script>
    
    <script src="chatbot.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if(typeof initializeChatbot === 'function') {
                initializeChatbot();
            } else {
                console.error("Warning: initializeChatbot function not found. Is chatbot.js loaded correctly?");
            }
            VANTA.NET({
                el: "#vanta-bg", mouseControls: true, touchControls: true, gyroControls: false, minHeight: 200.00, minWidth: 200.00, scale: 1.00, scaleMobile: 1.00, color: 0x22c55e, backgroundColor: 0xf9fafb, points: 12.00, maxDistance: 23.00, spacing: 18.00
            });
        });
    </script>
</body>
</html>